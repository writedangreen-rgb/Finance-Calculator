<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Semcasting | Incremental Media Performance Calculator (Demo)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a2a;
      --card2:#0f1626;
      --border:#22304d;
      --border2:#2a3a5e;
      --text:#e8eefc;
      --muted:rgba(232,238,252,.78);
      --muted2:rgba(232,238,252,.65);
      --accent:#4b78ff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 24px 18px 56px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 10px 12px; border: 1px solid var(--border);
      background: rgba(18,26,42,.75); border-radius: 14px;
      backdrop-filter: blur(6px);
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background: linear-gradient(135deg, var(--accent), #7aa2ff);
      box-shadow: 0 10px 24px rgba(75,120,255,.25);
    }
    .brand h1{ font-size: 15px; margin:0; letter-spacing:.2px; }
    .brand .sub{ font-size: 12px; color: var(--muted2); margin: 2px 0 0; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    button, select{
      border:1px solid var(--border2); background:#0b1220; color:var(--text);
      border-radius: 12px; padding: 10px 12px; cursor:pointer; font-size: 13px;
    }
    select{ cursor:pointer; }
    button:hover, select:hover{ border-color: var(--accent); }
    .primary{
      border-color: rgba(75,120,255,.65);
      background: rgba(75,120,255,.14);
    }
    .primary:hover{ border-color: var(--accent); background: rgba(75,120,255,.18); }

    .card{ background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-top: 14px; }
    .titlePrompt{
      font-weight: 800;
      font-size: 22px;
      line-height: 1.2;
      margin: 0 0 14px 0;
    }

    .row{ display:grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
    @media (min-width: 720px){ .row{ grid-template-columns: 1fr 1fr; } }

    .field{ background: var(--card2); border: 1px solid var(--border); border-radius: 12px; padding: 10px 10px; }
    label{ display:block; font-size: 14px; color: var(--muted); margin-bottom: 6px; font-weight: 650; }

    .hint{ font-size: 12px; color: var(--muted2); margin-top: 6px; line-height:1.25; font-weight: 600; }
    .divider{ height:1px; background: rgba(34,48,77,.9); margin: 12px 0; }

    .input-wrap{ position: relative; }
    .input-wrap .prefix, .input-wrap .suffix{
      position:absolute; top:50%; transform:translateY(-50%);
      opacity:.70; pointer-events:none; font-size: 14px; font-weight: 800;
    }
    .input-wrap .prefix{ left:10px; }
    .input-wrap .suffix{ right:10px; }

    input{
      width:100%; box-sizing:border-box;
      padding: 10px 10px; border-radius: 10px;
      border: 1px solid var(--border2);
      background: #0b1220; color: var(--text);
      font-size: 14px; outline: none;
    }
    input:focus{ border-color: var(--accent); }

    .pad-left{ padding-left: 28px !important; }
    .pad-right{ padding-right: 26px !important; }

    /* Percent fields: 5 characters wide visually + capped by maxlength=5 */
    .input-wrap.percent-wrap{ display:inline-block; }
    .input-wrap.percent-wrap input.percent{
      width: 5ch !important;
      min-width: 5ch !important;
      max-width: 5ch !important;
      text-align:right;
      box-sizing: content-box;
    }

    .ctaRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 6px; }
    .ctaBig{
      font-size: 16px;
      font-weight: 900;
      padding: 14px 18px;
      border-radius: 14px;
      min-width: 260px;
    }

    .outputsTitle{ font-size: 16px; font-weight: 850; margin: 0 0 10px; color: var(--muted); }
    .kpiGrid{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 720px){ .kpiGrid{ grid-template-columns: 1fr 1fr; } }

    .kpi{
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    .kpi .k{ font-size: 12px; color: var(--muted); font-weight: 800; }
    .kpi .v{ font-size: 20px; margin-top: 6px; font-weight: 900; }
    .kpi .m{ font-size: 12px; color: var(--muted2); margin-top: 6px; line-height: 1.25; }

    .err{ color:#ffb4b4; font-size: 12px; margin-top: 10px; display:none; font-weight: 700; }
    .foot{ margin-top: 14px; font-size: 11px; color: var(--muted2); line-height: 1.35; }

    @media print{
      body{ background:#fff; color:#111; }
      .topbar, .ctaRow, .noPrint{ display:none !important; }
      .card{ background:#fff; border:0; padding:0; margin:0; }
      .field{ border:1px solid #ddd; background:#fff; }
      input, select{ background:#fff; color:#111; border:1px solid #ddd; }
      .kpi{ background:#fff; border:1px solid #ddd; }
      .wrap{ max-width:none; padding:0; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Semcasting</h1>
          <div class="sub">Incremental Media Performance Calculator (Demo)</div>
        </div>
      </div>

      <div class="actions noPrint">
        <select id="benchmarkSelect" title="Benchmark set">
          <option value="standard">Benchmark: Standard</option>
          <option value="conservative">Benchmark: Conservative</option>
          <option value="aggressive">Benchmark: Aggressive</option>
        </select>
        <button id="copyBtn" type="button">Copy shareable link</button>
        <button id="pdfBtn" class="primary" type="button">Download PDF report</button>
        <button id="resetBtn" type="button">Reset to benchmark</button>
      </div>
    </div>

    <!-- INPUTS -->
    <div class="card" id="inputsCard">
      <p class="titlePrompt">
      <center>Drive Additional Mortgage Applications Through Media Measurement</center> </BR> </BR> Enter Key Metrics to Calculate the Incremental Impact for You
      </p>

      <div class="row">
        <div class="field">
          <label for="budget">Estimated Display and CTV Digital Marketing Budget</label>
          <div class="input-wrap">
            <span class="prefix">$</span>
            <input id="budget" class="money pad-left" inputmode="decimal" value="10,000,000.00" required>
          </div>
          <div class="hint">benchmark: varies by preset</div>
        </div>

        <div class="field">
          <label for="cpm">Estimated Blended CPM</label>
          <div class="input-wrap">
            <span class="prefix">$</span>
            <input id="cpm" class="money pad-left" inputmode="decimal" value="15.00" required>
          </div>
          <div class="hint">benchmark: varies by preset</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="ctr">Estimated Click-Through / View-Through Rate</label>
          <div class="input-wrap percent-wrap">
            <input id="ctr" class="percent pad-right" inputmode="decimal" maxlength="5" value="0.15" required>
            <span class="suffix">%</span>
          </div>
          <div class="hint">benchmark: varies by preset</div>
        </div>

        <div class="field">
          <label for="startRate">Estimated Application Start Rate</label>
          <div class="input-wrap percent-wrap">
            <input id="startRate" class="percent pad-right" inputmode="decimal" maxlength="5" value="0.40" required>
            <span class="suffix">%</span>
          </div>
          <div class="hint">benchmark: varies by preset</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="completionRate">Estimated Application Completion Rate</label>
          <div class="input-wrap percent-wrap">
            <input id="completionRate" class="percent pad-right" inputmode="decimal" maxlength="5" value="40" required>
            <span class="suffix">%</span>
          </div>
          <div class="hint">benchmark: varies by preset</div>
        </div>

        <div class="field">
          <label for="fundedRate">Estimated Application Funded Rate</label>
          <div class="input-wrap percent-wrap">
            <input id="fundedRate" class="percent pad-right" inputmode="decimal" maxlength="5" value="50" required>
            <span class="suffix">%</span>
          </div>
          <div class="hint">benchmark: varies by preset</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="siteVisitors">Estimated Current Site Visitors (per year)</label>
          <input id="siteVisitors" inputmode="numeric" value="1,200,000" required>
          <div class="hint">benchmark: varies by preset</div>
        </div>

        <div class="field">
          <label for="ltv">Lifetime Value of a Funded Loan</label>
          <div class="input-wrap">
            <span class="prefix">$</span>
            <input id="ltv" class="money pad-left" inputmode="decimal" value="9,000.00" required>
          </div>
          <div class="hint">benchmark: $9,000</div>
        </div>
      </div>

      <!-- Incremental lift input -->
      <div class="row">
        <div class="field">
          <label for="liftPct">Estimated Incremental Lift from Measurement</label>
          <div class="input-wrap percent-wrap">
            <input id="liftPct" class="percent pad-right" inputmode="decimal" maxlength="5" value="10" required>
            <span class="suffix">%</span>
          </div>
          <div class="hint">benchmark: 10% (applies to total funded volume)</div>
        </div>

        <div class="field">
          <label for="notes">Notes (optional; included in PDF)</label>
          <input id="notes" type="text" placeholder="Prospect name, campaign, assumptions…">
          <div class="hint">benchmark: (optional)</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="field">
          <label>&nbsp;</label>
          <div class="ctaRow noPrint">
            <button id="calcBtn" class="primary ctaBig" type="button">Calculate</button>
          </div>
          <div id="err" class="err"></div>
        </div>

        <div class="field">
          <div class="foot">
            For demo/testing purposes. Calculations are driven entirely by the inputs shown.
          </div>
        </div>
      </div>
    </div>

    <!-- OUTPUTS -->
    <div class="card" id="outputsCard">
      <p class="outputsTitle">Outputs</p>

      <div class="kpiGrid">
        <div class="kpi">
          <div class="k">All Impressions Delivered (Banner/CTV)</div>
          <div class="v" id="o_impr">—</div>
          <div class="m" id="o_impr_mini">—</div>
        </div>

        <div class="kpi">
          <div class="k">Total Application Starts</div>
          <div class="v" id="o_starts">—</div>
          <div class="m" id="o_starts_mini">—</div>
        </div>

        <div class="kpi">
          <div class="k">Total Application Completions</div>
          <div class="v" id="o_comp">—</div>
          <div class="m" id="o_comp_mini">—</div>
        </div>

        <div class="kpi">
          <div class="k">Total Application Funded</div>
          <div class="v" id="o_funded">—</div>
          <div class="m" id="o_funded_mini">—</div>
        </div>

        <div class="kpi">
          <div class="k">Total Direct Revenue from Digital Advertising (Base)</div>
          <div class="v" id="o_rev_base">—</div>
          <div class="m" id="o_rev_base_mini">—</div>
        </div>

        <div class="kpi">
          <div class="k">Total Direct Revenue from Digital Advertising (With Measurement)</div>
          <div class="v" id="o_rev_meas">—</div>
          <div class="m" id="o_rev_meas_mini">—</div>
        </div>

        <div class="kpi">
          <div class="k">Incremental Funded Applications from Measurement</div>
          <div class="v" id="o_inc_funded">—</div>
          <div class="m" id="o_inc_funded_mini">—</div>
        </div>

        <div class="kpi">
          <div class="k">Incremental Direct Revenue from Measurement</div>
          <div class="v" id="o_inc_rev">—</div>
          <div class="m" id="o_inc_rev_mini">—</div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const els = {
    benchmarkSelect: $("benchmarkSelect"),
    budget: $("budget"),
    cpm: $("cpm"),
    ctr: $("ctr"),
    startRate: $("startRate"),
    completionRate: $("completionRate"),
    fundedRate: $("fundedRate"),
    siteVisitors: $("siteVisitors"),
    ltv: $("ltv"),
    liftPct: $("liftPct"),
    notes: $("notes"),

    err: $("err"),
    calcBtn: $("calcBtn"),
    resetBtn: $("resetBtn"),
    copyBtn: $("copyBtn"),
    pdfBtn: $("pdfBtn"),

    o_impr: $("o_impr"),
    o_impr_mini: $("o_impr_mini"),
    o_starts: $("o_starts"),
    o_starts_mini: $("o_starts_mini"),
    o_comp: $("o_comp"),
    o_comp_mini: $("o_comp_mini"),
    o_funded: $("o_funded"),
    o_funded_mini: $("o_funded_mini"),

    o_rev_base: $("o_rev_base"),
    o_rev_base_mini: $("o_rev_base_mini"),
    o_rev_meas: $("o_rev_meas"),
    o_rev_meas_mini: $("o_rev_meas_mini"),
    o_inc_funded: $("o_inc_funded"),
    o_inc_funded_mini: $("o_inc_funded_mini"),
    o_inc_rev: $("o_inc_rev"),
    o_inc_rev_mini: $("o_inc_rev_mini"),
  };

  // ---------- Benchmarks ----------
  const BENCHMARKS = {
    standard: {
      budget: 10000000,
      cpm: 15,
      ctr: 0.15,
      startRate: 0.40,
      completionRate: 40,
      fundedRate: 50,
      siteVisitors: 1200000,
      ltv: 9000,
      liftPct: 10
    },
    conservative: {
      budget: 5000000,
      cpm: 18,
      ctr: 0.10,
      startRate: 0.30,
      completionRate: 35,
      fundedRate: 45,
      siteVisitors: 800000,
      ltv: 9000,
      liftPct: 7.5
    },
    aggressive: {
      budget: 15000000,
      cpm: 12,
      ctr: 0.25,
      startRate: 0.60,
      completionRate: 45,
      fundedRate: 60,
      siteVisitors: 1500000,
      ltv: 9000,
      liftPct: 15
    }
  };

  // ---------- Formatting helpers ----------
  function stripNonNumeric(s){
    return (s || "").toString().replace(/[^0-9.]/g, "");
  }
  function parseNumberFromInput(el){
    const raw = stripNonNumeric(el.value).replace(/(\..*)\./g, "$1");
    const n = parseFloat(raw);
    return isFinite(n) ? n : NaN;
  }

  function setFormattedCurrency(el, value){
    if (!isFinite(value)) { el.value = ""; return; }
    el.value = value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function setFormattedInteger(el, value){
    if (!isFinite(value)) { el.value = ""; return; }
    el.value = Math.round(value).toLocaleString(undefined, { maximumFractionDigits: 0 });
  }
  function setFormattedPercent(el, value){
    if (!isFinite(value)) { el.value = ""; return; }
    const v = Math.round(value * 100) / 100;
    el.value = String(v).slice(0,5);
  }

  function fmtMoney0(x){
    if (!isFinite(x)) return "—";
    return x.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
  }
  function fmtInt(x){
    if (!isFinite(x)) return "—";
    return x.toLocaleString(undefined,{maximumFractionDigits:0});
  }

  function showErr(msg){
    els.err.style.display = msg ? "block" : "none";
    els.err.textContent = msg || "";
  }

  // Percent enforcement: max 5 chars, max 2 decimals, clamp 0-100
  function attachPercentRules(id){
    const el = $(id);
    el.addEventListener("input", () => {
      let v = el.value.replace(/[^0-9.]/g,'');
      const parts = v.split('.');
      if (parts.length > 2) v = parts[0] + '.' + parts.slice(1).join('');
      if (v.includes('.')) {
        const [a,b] = v.split('.');
        v = a + '.' + (b ?? '').slice(0,2);
      }
      if (v.length > 5) v = v.slice(0,5);
      el.value = v;
    });
    el.addEventListener("blur", () => {
      const n = parseFloat(el.value || "0");
      const clamped = Math.min(Math.max(isFinite(n) ? n : 0, 0), 100);
      el.value = String(Math.round(clamped * 100) / 100).slice(0,5);
    });
  }

  function wireCurrency(id, defaultValue){
    const el = $(id);
    el.addEventListener("focus", () => {
      const n = parseNumberFromInput(el);
      el.value = isFinite(n) ? String(n) : "";
    });
    el.addEventListener("blur", () => {
      const n = parseNumberFromInput(el);
      setFormattedCurrency(el, isFinite(n) ? n : defaultValue);
    });
  }

  function wireInteger(id, defaultValue){
    const el = $(id);
    el.addEventListener("focus", () => {
      const n = parseNumberFromInput(el);
      el.value = isFinite(n) ? String(Math.round(n)) : "";
    });
    el.addEventListener("blur", () => {
      const n = parseNumberFromInput(el);
      setFormattedInteger(el, isFinite(n) ? n : defaultValue);
    });
  }

  function pctToDec(percentNumber, name){
    if (!isFinite(percentNumber)) throw new Error(`${name} must be a number.`);
    if (percentNumber < 0 || percentNumber > 100) throw new Error(`${name} must be between 0 and 100.`);
    return percentNumber / 100.0;
  }

  function readInputs(){
    const budget = parseNumberFromInput(els.budget);
    if (!isFinite(budget) || budget < 0) throw new Error("Budget must be a number ≥ 0.");

    const cpm = parseNumberFromInput(els.cpm);
    if (!isFinite(cpm) || cpm < 2) throw new Error("CPM must be a number ≥ 2.");

    const ctr = pctToDec(parseNumberFromInput(els.ctr), "Estimated Click-Through / View-Through Rate (%)");
    const startRate = pctToDec(parseNumberFromInput(els.startRate), "Estimated Application Start Rate (%)");
    const completionRate = pctToDec(parseNumberFromInput(els.completionRate), "Estimated Application Completion Rate (%)");
    const fundedRate = pctToDec(parseNumberFromInput(els.fundedRate), "Estimated Application Funded Rate (%)");

    const siteVisitors = parseNumberFromInput(els.siteVisitors);
    if (!isFinite(siteVisitors) || siteVisitors < 0) throw new Error("Site Visitors must be a number ≥ 0.");

    const ltv = parseNumberFromInput(els.ltv);
    if (!isFinite(ltv) || ltv < 0) throw new Error("Lifetime Value of a Funded Loan must be ≥ 0.");

    const liftPct = pctToDec(parseNumberFromInput(els.liftPct), "Estimated Incremental Lift from Measurement (%)");

    return { budget, cpm, ctr, startRate, completionRate, fundedRate, siteVisitors, ltv, liftPct };
  }

  function calc(){
    try{
      showErr("");
      const i = readInputs();

      // Base funnel
      const impressions = (i.budget / i.cpm) * 1000;
      const totalStarts = impressions * i.ctr * i.startRate;
      const totalCompletions = totalStarts * i.completionRate;
      const totalFunded = totalCompletions * i.fundedRate;

      const baseRevenue = totalFunded * i.ltv;

      // Measurement lift (applied to funded volume, conservative and transparent)
      const measFunded = totalFunded * (1 + i.liftPct);
      const measRevenue = measFunded * i.ltv;

      const incFunded = measFunded - totalFunded;
      const incRevenue = measRevenue - baseRevenue;

      // Render base funnel outputs
      els.o_impr.textContent = fmtInt(impressions);
      els.o_impr_mini.textContent = "Computed as (Budget ÷ CPM) × 1000";

      els.o_starts.textContent = fmtInt(totalStarts);
      els.o_starts_mini.textContent = "Impressions × CTR/VTR × Application Start Rate";

      els.o_comp.textContent = fmtInt(totalCompletions);
      els.o_comp_mini.textContent = "Total Application Starts × Application Completion Rate";

      els.o_funded.textContent = fmtInt(totalFunded);
      els.o_funded_mini.textContent = "Total Application Completions × Application Funded Rate";

      // Revenue outputs
      els.o_rev_base.textContent = fmtMoney0(baseRevenue);
      els.o_rev_base_mini.textContent = "Total Application Funded × Lifetime Value of a Funded Loan";

      els.o_rev_meas.textContent = fmtMoney0(measRevenue);
      els.o_rev_meas_mini.textContent = `Applies measurement lift of ${(i.liftPct*100).toFixed(2).replace(/\.00$/,'')}% to funded volume`;

      els.o_inc_funded.textContent = fmtInt(incFunded);
      els.o_inc_funded_mini.textContent = "With Measurement Funded − Base Funded";

      els.o_inc_rev.textContent = fmtMoney0(incRevenue);
      els.o_inc_rev_mini.textContent = "With Measurement Revenue − Base Revenue";

      syncUrl();
      document.getElementById("outputsCard").scrollIntoView({ behavior: "smooth", block: "start" });
    } catch(e){
      showErr(e.message || "Check your inputs.");
    }
  }

  function escapeHtml(str){
    return (str || "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function getSnapshot(){
    const now = new Date();
    const iv = (id) => $(id).value;

    const inputs = [
      ["Estimated Display and CTV Digital Marketing Budget", "$" + escapeHtml(iv("budget"))],
      ["Estimated Blended CPM", "$" + escapeHtml(iv("cpm"))],
      ["Estimated Click-Through / View-Through Rate", escapeHtml(iv("ctr")) + "%"],
      ["Estimated Application Start Rate", escapeHtml(iv("startRate")) + "%"],
      ["Estimated Application Completion Rate", escapeHtml(iv("completionRate")) + "%"],
      ["Estimated Application Funded Rate", escapeHtml(iv("fundedRate")) + "%"],
      ["Estimated Current Site Visitors (per year)", escapeHtml(iv("siteVisitors"))],
      ["Lifetime Value of a Funded Loan", "$" + escapeHtml(iv("ltv"))],
      ["Estimated Incremental Lift from Measurement", escapeHtml(iv("liftPct")) + "%"],
      ["Benchmark preset", escapeHtml(els.benchmarkSelect.value)],
    ];

    const outputs = [
      ["All Impressions Delivered (Banner/CTV)", escapeHtml(els.o_impr.textContent)],
      ["Total Application Starts", escapeHtml(els.o_starts.textContent)],
      ["Total Application Completions", escapeHtml(els.o_comp.textContent)],
      ["Total Application Funded", escapeHtml(els.o_funded.textContent)],
      ["Total Direct Revenue from Digital Advertising (Base)", escapeHtml(els.o_rev_base.textContent)],
      ["Total Direct Revenue from Digital Advertising (With Measurement)", escapeHtml(els.o_rev_meas.textContent)],
      ["Incremental Funded Applications from Measurement", escapeHtml(els.o_inc_funded.textContent)],
      ["Incremental Direct Revenue from Measurement", escapeHtml(els.o_inc_rev.textContent)],
    ];

    return {
      generatedAt: now.toLocaleString(),
      notes: (els.notes.value || "").trim(),
      shareLink: location.href,
      inputs,
      outputs
    };
  }

  function openPdfReport(){
    // Ensure outputs reflect current inputs
    calc();
    const snap = getSnapshot();

    const style = `
      <style>
        @page { margin: 18mm; }
        body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
        .hdr{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
        .brand{ display:flex; align-items:center; gap:10px; }
        .logo{ width:30px; height:30px; border-radius:8px; background: linear-gradient(135deg, #4b78ff, #7aa2ff); }
        h1{ font-size: 16px; margin:0; }
        .meta{ font-size: 11px; color:#444; text-align:right; }
        .sub{ margin: 10px 0 14px; color:#333; font-size:12px; line-height:1.35; }
        .box{ border:1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; }
        h2{ font-size: 13px; margin: 0 0 10px; }
        table{ width:100%; border-collapse: collapse; font-size: 12px; }
        td{ padding: 8px 6px; border-bottom: 1px solid #eee; vertical-align: top; }
        td:first-child{ width: 64%; color:#222; }
        td:last-child{ width: 36%; text-align:right; font-weight:600; }
        .note{ font-size: 12px; color:#333; white-space: pre-wrap; }
        .footer{ margin-top: 14px; font-size: 10px; color:#666; line-height:1.35; }
        .pill{ display:inline-block; padding: 2px 8px; border:1px solid #e5e5e5; border-radius:999px; font-size:11px; color:#444; }
        @media print{ .noprint{ display:none; } }
      </style>
    `;

    const rows = (arr) => arr.map(([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("");

    // IMPORTANT: no <script> tags inside template strings (prevents breaking main page JS)
    const html = `
      <!doctype html>
      <html>
      <head><meta charset="utf-8">${style}<title>Semcasting Report</title></head>
      <body onload="setTimeout(()=>window.print(),250)">
        <div class="hdr">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
              <h1>Semcasting — Incremental Media Performance (Demo Report)</h1>
              <div class="sub" style="margin:4px 0 0; font-size:11px; color:#555;">
                Financial Organization Planning Outputs
              </div>
            </div>
          </div>
          <div class="meta">
            <div><span class="pill">Generated</span> ${escapeHtml(snap.generatedAt)}</div>
          </div>
        </div>

        <div class="sub">
          Impressions are computed as <b>(Budget ÷ CPM) × 1000</b>. Measurement impact is modeled as an <b>incremental lift applied to funded volume</b>.
        </div>

        ${snap.notes ? `
          <div class="box">
            <h2>Notes</h2>
            <div class="note">${escapeHtml(snap.notes)}</div>
          </div>
        ` : ""}

        <div class="box">
          <h2>Inputs</h2>
          <table>${rows(snap.inputs)}</table>
        </div>

        <div class="box">
          <h2>Outputs</h2>
          <table>${rows(snap.outputs)}</table>
        </div>

        <div class="footer">
          Shareable link: ${escapeHtml(snap.shareLink)}<br/>
          For demo/testing purposes. © ${new Date().getFullYear()} Semcasting.
        </div>

        <div class="noprint" style="margin-top:14px;">
          <button onclick="window.print()" style="padding:10px 12px; border:1px solid #bbb; border-radius:10px; background:#fff; cursor:pointer;">
            Print / Save as PDF
          </button>
        </div>
      </body>
      </html>
    `;

    const w = window.open("", "_blank", "noopener,noreferrer");
    if (!w) return;
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function syncUrl(){
    const num = (id) => {
      const v = parseNumberFromInput($(id));
      return isFinite(v) ? String(v) : "";
    };
    const params = new URLSearchParams({
      preset: els.benchmarkSelect.value,
      b: num("budget"),
      cpm: num("cpm"),
      ctr: num("ctr"),
      sr: num("startRate"),
      cr: num("completionRate"),
      fr: num("fundedRate"),
      sv: num("siteVisitors"),
      ltv: num("ltv"),
      lift: num("liftPct"),
      n: els.notes.value || ""
    });
    history.replaceState(null, "", `${location.origin}${location.pathname}?${params.toString()}`);
  }

  function loadFromUrl(){
    const p = new URLSearchParams(location.search);
    if (!p.toString()) return;

    if (p.has("preset") && BENCHMARKS[p.get("preset")]) {
      els.benchmarkSelect.value = p.get("preset");
    }

    const setNum = (key, elId, formatFn) => {
      if (!p.has(key)) return;
      const n = parseFloat(p.get(key));
      if (!isFinite(n)) return;
      formatFn($(elId), n);
    };

    setNum("b","budget", setFormattedCurrency);
    setNum("cpm","cpm", setFormattedCurrency);
    setNum("ltv","ltv", setFormattedCurrency);

    setNum("ctr","ctr", setFormattedPercent);
    setNum("sr","startRate", setFormattedPercent);
    setNum("cr","completionRate", setFormattedPercent);
    setNum("fr","fundedRate", setFormattedPercent);
    setNum("lift","liftPct", setFormattedPercent);

    setNum("sv","siteVisitors", setFormattedInteger);

    if (p.has("n")) $("notes").value = p.get("n");
  }

  function copyShareLink(){
    navigator.clipboard.writeText(location.href).then(()=>{
      els.copyBtn.textContent = "Link copied";
      setTimeout(()=> els.copyBtn.textContent = "Copy shareable link", 1200);
    }).catch(()=>{
      els.copyBtn.textContent = "Copy failed";
      setTimeout(()=> els.copyBtn.textContent = "Copy shareable link", 1200);
    });
  }

  function clearOutputs(){
    [
      "o_impr","o_starts","o_comp","o_funded",
      "o_rev_base","o_rev_meas","o_inc_funded","o_inc_rev",
      "o_impr_mini","o_starts_mini","o_comp_mini","o_funded_mini",
      "o_rev_base_mini","o_rev_meas_mini","o_inc_funded_mini","o_inc_rev_mini"
    ].forEach(id => { if ($(id)) $(id).textContent = "—"; });
  }

  function applyPreset(presetKey){
    const b = BENCHMARKS[presetKey] || BENCHMARKS.standard;
    setFormattedCurrency(els.budget, b.budget);
    setFormattedCurrency(els.cpm, b.cpm);
    setFormattedPercent(els.ctr, b.ctr);
    setFormattedPercent(els.startRate, b.startRate);
    setFormattedPercent(els.completionRate, b.completionRate);
    setFormattedPercent(els.fundedRate, b.fundedRate);
    setFormattedInteger(els.siteVisitors, b.siteVisitors);
    setFormattedCurrency(els.ltv, b.ltv);
    setFormattedPercent(els.liftPct, b.liftPct);
    els.notes.value = els.notes.value || "";
    showErr("");
    clearOutputs();
    syncUrl();
  }

  // Wire formatting behaviors
  wireCurrency("budget", BENCHMARKS.standard.budget);
  wireCurrency("cpm", BENCHMARKS.standard.cpm);
  wireCurrency("ltv", BENCHMARKS.standard.ltv);
  wireInteger("siteVisitors", BENCHMARKS.standard.siteVisitors);

  ["ctr","startRate","completionRate","fundedRate","liftPct"].forEach(attachPercentRules);

  // Init
  loadFromUrl();
  // If no query params, apply standard preset
  if (!location.search) {
    els.benchmarkSelect.value = "standard";
    applyPreset("standard");
  } else {
    // Keep current values, but ensure URL includes preset
    if (!new URLSearchParams(location.search).has("preset")) syncUrl();
  }

  // Buttons / controls
  els.calcBtn.addEventListener("click", calc);
  els.resetBtn.addEventListener("click", () => applyPreset(els.benchmarkSelect.value));
  els.copyBtn.addEventListener("click", copyShareLink);
  els.pdfBtn.addEventListener("click", openPdfReport);
  els.benchmarkSelect.addEventListener("change", () => applyPreset(els.benchmarkSelect.value));
</script>
</body>
</html>
